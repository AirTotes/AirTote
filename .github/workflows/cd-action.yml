name: Continuous Delivery Action

on:
  push:
    branches:
      - main
    tags:
      - 'bundle[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    types:
      - opened
      - synchronize
  workflow_dispatch:

env:
  CSPROJ_PATH: ./AirTote/AirTote.csproj
  IPA_PATH: ./AirTote/bin/Publish/net6.0-ios/ios-arm64/publish/AirTote.ipa

jobs:
  dump-context:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: dump `github` context
        env:
          __CONTEXT: ${{ toJSON(github) }}
        run: echo "$__CONTEXT"

  generate-bundle-version:
    if: ${{ !startsWith(github.ref, 'refs/tags/bundle') }}
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      display_version: ${{ steps.set_display_version.outputs.disp-version }}
      bundle_version: ${{ steps.set_version_number.outputs.version }}

    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{github.head_ref}}

    - name: Get all tags from remote
      run: git fetch --all --tags

    - name: generate bundle version pattern (Trigger:Push to main)
      if: ${{ github.event_name == 'push' }}
      run: grep -oP '(?<=<ApplicationDisplayVersion>).*?(?=</ApplicationDisplayVersion>)' ${{ env.CSPROJ_PATH }} > BUNDLE_VERSION_MAJOR_MINOR

    - name: generate bundle version pattern (Trigger:PullRequest)
      if: ${{ github.event_name == 'pull_request' }}
      run: echo "0.${{ github.event.number }}" > BUNDLE_VERSION_MAJOR_MINOR

    - name: generate bundle version pattern (Trigger:WorkflowDispatch)
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: echo "0.0.1" > BUNDLE_VERSION_MAJOR_MINOR

    - name: set major/minor version to variable
      id: set_display_version
      run: |
        echo "::set-output name=disp-version::$(cat BUNDLE_VERSION_MAJOR_MINOR)"
        echo "::set-output name=major-minor-version::$(cat BUNDLE_VERSION_MAJOR_MINOR | awk -F '.' '{print $1 "." $2}')"

    - name: Get all tags reachable from current commit
      run: |
        git tag -l "bundle${{ steps.set_display_version.outputs.major-minor-version }}.[0-9]*" > BUNDLE_VERSIONS
        cat BUNDLE_VERSIONS

    - name: Generate new patch version number
      id: patch_version
      run: |
        if [ `cat BUNDLE_VERSIONS | wc -l` -eq 0 ]; then
          PATCH_VERSION=0
        else
          PATCH_VERSION=`sort -rV BUNDLE_VERSIONS | head -n 1 | awk -F '.' '{print $3 + 1}'`
        fi
        echo "::set-output name=version::$PATCH_VERSION"

    - name: set version number
      id: set_version_number
      run: echo "::set-output name=version::${{ steps.set_display_version.outputs.major-minor-version }}.${{ steps.patch_version.outputs.version }}"

    - name: print new version number
      run: echo "VersionNumber (Bundle Version) ... ${{ steps.set_version_number.outputs.version }}"

  dump-context-1:
    if: ${{ !failure() }}
    runs-on: ubuntu-latest
    timeout-minutes: 1
    needs: generate-bundle-version
    steps:
      - name: dump `needs` context
        env:
          __CONTEXT: ${{ toJSON(needs) }}
        run: echo "$__CONTEXT"
  dump-context-2:
    if: ${{ !failure() }}
    runs-on: ubuntu-latest
    timeout-minutes: 1
    needs: build-publish-ios
    steps:
      - name: dump `needs` context
        env:
          __CONTEXT: ${{ toJSON(needs) }}
        run: echo "$__CONTEXT"

  build-publish-ios:
    if: |
      !failure() && 
      (
        needs.generate-bundle-version.result == 'success'
        || needs.generate-bundle-version.result == 'skipped'
      )

    runs-on: [self-hosted, macOS]
    timeout-minutes: 20
    needs: generate-bundle-version

    steps:
    - name: get version
      id: get-version
      run: |
        if [ '${{ startsWith(github.ref, 'refs/tags/bundle') }}' == 'true' ]; then
          VERSION=`echo '${{ github.ref }}' | tr -d 'refs/tags/bundle'`
          echo "::set-output name=bundle_version::$VERSION"
          echo "::set-output name=display_version::$(echo $VERSION | awk -F '.' '{print $1 "." $2}')"
        else
          echo "::set-output name=bundle_version::${{ needs.generate-bundle-version.outputs.bundle_version }}"
          echo "::set-output name=display_version::${{ needs.generate-bundle-version.outputs.display_version }}"
        fi

    - uses: actions/checkout@v2

    - name: Install dependencies
      run: dotnet restore ${{ env.CSPROJ_PATH }}

    - name: Build
      run: >
        dotnet publish ${{ env.CSPROJ_PATH }}
        -f:net6.0-ios
        -r ios-arm64
        -c Publish
        /p:ApplicationVersion=${{ steps.get-version.outputs.bundle_version }}
        /p:ApplicationDisplayVersion=${{ steps.get-version.outputs.display_version }}
    
    - name: validate
      run: >
        xcrun altool
        --validate-app
        --type ios
        -f ${{ env.IPA_PATH }}
        --apiKey ${{ secrets.APPSTORECONNECT_API_KEY }}
        --apiIssuer ${{ secrets.APPSTORECONNECT_ISSUER_ID }}

    - name: upload
      run: >
        xcrun altool
        --upload-app
        --type ios
        -f ${{ env.IPA_PATH }}
        --apiKey ${{ secrets.APPSTORECONNECT_API_KEY }}
        --apiIssuer ${{ secrets.APPSTORECONNECT_ISSUER_ID }}

    - name: Upload IPA
      uses: actions/upload-artifact@v3.0.0
      with:
        name: ipa
        path: ${{ env.IPA_PATH }}
        retention-days: 3

  set-tag:
    if: |
      needs.generate-bundle-version.result == 'success'
      && needs.build-publish-ios.result == 'success'

    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - generate-bundle-version
      - build-publish-ios

    steps:
    - uses: actions/checkout@v3

    - name: Setup github-actions[bot] account
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'

    - name: set PR number
      id: pr-num
      if: ${{ github.event_name == 'pull_request' }}
      run: echo "::set-output name=str::#${{ github.event.number }}"

    - name: generate tag name
      id: tag-name
      run: echo "::set-output name=tag-name::bundle${{ needs.generate-bundle-version.outputs.bundle_version }}"

    - name: tagging new tag
      run: git tag -a ${{ steps.tag-name.outputs.tag-name }} -m "Auto Generated tag ${{ steps.pr-num.outputs.str }} ( https://github.com/${{github.repository}}/actions/runs/${{github.run_id}} )"

    - name: push new tag
      run: git push origin ${{ steps.tag-name.outputs.tag-name }}
    
    - name: Comment TagName and Actions-Run URL to PR
      if: ${{ github.event_name == 'pull_request' }}
      run: >
        echo Tag \`${{ steps.tag-name.outputs.tag-name }}\` was automatically created and pushed with
        ... https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
        | gh pr comment ${{ github.event.number }} -F -
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
